// Load environment variables from .env file
require('dotenv').config();
const axios = require('axios');
const fs = require('fs');
const path = require('path');
const QRCode = require('qrcode');

// Controller function to process form data and send it to Telegram
const submitStudentForm = async (req, res) => {
  try {
    const studentData = req.body;

    // Convert student data to JSON string
    const studentJson = JSON.stringify(studentData, null, 2);

    // Prepare the message to send to Telegram
    const messageText = `New Student Registration:\n${studentJson}`;

    // Send message to Telegram channel with inline keyboard buttons
    await axios.post(`https://api.telegram.org/bot${process.env.TELEGRAM_BOT_TOKEN}/sendMessage`, {
      chat_id: process.env.TELEGRAM_CHANNEL_ID,
      text: messageText,
      reply_markup: {
        inline_keyboard: [
          [
            {
              text: "Approve",
              callback_data: studentData.idNumber, // Use the student's ID number as the callback data
            },
            {
              text: "Disapprove",
              callback_data: "disapprove", // Can handle this in your webhook
            },
          ],
        ],
      },
    });

    // Handle file uploads
    if (req.files && req.files.cv) {
      const cvFile = req.files.cv; // Assuming 'cv' is the name of the file input in your form

      // Save the file to your server
      const cvPath = path.join(__dirname, 'uploads', cvFile.name); // Ensure uploads directory exists
      await cvFile.mv(cvPath); // Move file to your desired location

      // Optionally send the CV file to Telegram
      await axios.post(`https://api.telegram.org/bot${process.env.TELEGRAM_BOT_TOKEN}/sendDocument`, {
        chat_id: process.env.TELEGRAM_CHANNEL_ID,
        document: fs.createReadStream(cvPath), // Stream the file to Telegram
      });
    }

    // Return success response
    res.status(200).json({ message: 'Form submitted and sent to Telegram!' });
  } catch (error) {
    console.error('Error submitting form:', error);
    res.status(500).json({ message: 'Error submitting form' });
  }
};

// Function to handle the approved callback query
const handleApproval = async (req, res) => {
  const { callback_query } = req.body; // Extract callback query data
  const studentIdNumber = callback_query.data; // Assuming the student ID number is passed in the callback data
  const chatId = callback_query.from.id; // Telegram user ID

  try {
    // Generate QR code based on student ID number
    const qrCodeData = `ID Number: ${studentIdNumber}`;
    const qrCodePath = path.join(__dirname, 'uploads', `${studentIdNumber}.png`);

    await QRCode.toFile(qrCodePath, qrCodeData); // Generate QR code image

    // Send the QR code back to the user via Telegram
    await axios.post(`https://api.telegram.org/bot${process.env.TELEGRAM_BOT_TOKEN}/sendPhoto`, {
      chat_id: chatId,
      photo: fs.createReadStream(qrCodePath), // Send the QR code image
      caption: `Your QR Code has been generated for ID Number: ${studentIdNumber}`,
    });

    // Optionally, you can send a success message to the Telegram channel or log it
    await axios.post(`https://api.telegram.org/bot${process.env.TELEGRAM_BOT_TOKEN}/sendMessage`, {
      chat_id: process.env.TELEGRAM_CHANNEL_ID,
      text: `Student with ID Number ${studentIdNumber} has been approved and notified with a QR code.`,
    });

    // Return success response
    res.status(200).json({ message: 'QR code generated and sent to user!' });
  } catch (error) {
    console.error('Error approving student:', error);
    res.status(500).json({ message: 'Error approving student' });
  }
};

module.exports = { submitStudentForm, handleApproval };
